<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating a Secret Ballot | Documentation</title>
    <meta name="description" content="Oasis Developer Documentation">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.d6e79f13.css" as="style"><link rel="preload" href="/assets/js/app.f0c452a0.js" as="script"><link rel="preload" href="/assets/js/2.8656bac5.js" as="script"><link rel="preload" href="/assets/js/8.8c045a5f.js" as="script"><link rel="prefetch" href="/assets/js/10.4063fb1d.js"><link rel="prefetch" href="/assets/js/3.1b6d54e0.js"><link rel="prefetch" href="/assets/js/4.a306e92f.js"><link rel="prefetch" href="/assets/js/5.8dc68c3a.js"><link rel="prefetch" href="/assets/js/6.4b392c99.js"><link rel="prefetch" href="/assets/js/7.fe35458b.js"><link rel="prefetch" href="/assets/js/9.078f9812.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6e79f13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Documentation" class="logo"> <span class="site-name can-hide">Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://oasislabs.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://dashboard.oasiscloud.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dashboard
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/oasislabs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://oasislabs.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://dashboard.oasiscloud.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dashboard
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/oasislabs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/overview.html" class="sidebar-link">Overview</a></li><li><a href="/quickstart.html" class="sidebar-link">Quickstart</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Tutorials</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tutorials/ballot.html" class="active sidebar-link">Beginner: Secret Ballot</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#create-a-new-project" class="sidebar-link">Create a New Project</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#setting-up-dependencies" class="sidebar-link">Setting up dependencies</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#defining-the-ballot-service" class="sidebar-link">Defining the Ballot Service</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#testing" class="sidebar-link">Testing</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#onward-to-messages-of-victory" class="sidebar-link">Onward to (messages of) victory!</a></li></ul></li><li><a href="/tutorials/messaging.html" class="sidebar-link">Intermediate: Private Chat</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="creating-a-secret-ballot"><a href="#creating-a-secret-ballot" aria-hidden="true" class="header-anchor">#</a> Creating a Secret Ballot</h1> <p>In this tutorial we will create a secret ballot service that allows participants to vote for a candidate without revealing their identity or their vote.
Because the service runs on the Oasis platform, we can be confident that the election cannot be rigged.</p> <p><strong>tl;dr:</strong> The code for this example can be found at <a href="https://github.com/oasislabs/oasis-rs/tree/master/examples/ballot" target="_blank" rel="noopener noreferrer">https://github.com/oasislabs/oasis-rs/tree/master/examples/ballot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h2> <p>Building and running this tutorial will require the Oasis toolchain.
If you haven't yet installed it, please peruse the <a href="/quickstart">Quickstart guide</a>.</p> <h2 id="create-a-new-project"><a href="#create-a-new-project" aria-hidden="true" class="header-anchor">#</a> Create a New Project</h2> <p>Oasis services are currently developed using the Rust programming language.
If you are unfamiliar with Rust, the <a href="https://doc.rust-lang.org/nightly/book/" target="_blank" rel="noopener noreferrer">Rust book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an excellent place to start.</p> <p>Since an Oasis service is just a Rust program with an extra library and build step, we can use standard Rust tooling.
Accordingly, you can create a new project using Rust's package manager, <code>cargo</code>:</p> <div class="language- extra-class"><pre class="language-text"><code>oasis init ballot &amp;&amp; cd ballot
</code></pre></div><p>If you type <code>ls -r</code>  you will find yourself in a Git repo that has been populated with <code>Cargo.toml</code> and <code>src/main.rs</code>, among other things.
If you're coming from JavaScript, <code>Cargo.toml</code> is the Rust version of <code>package.json</code> and <code>main.rs</code> is akin to <code>index.js</code>.
For more information, the <a href="https://doc.rust-lang.org/nightly/cargo/" target="_blank" rel="noopener noreferrer">Cargo book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an fine reference.
The <a href="https://doc.rust-lang.org/nightly/cargo/guide/creating-a-new-project.html" target="_blank" rel="noopener noreferrer">Creating a New Package<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://doc.rust-lang.org/nightly/cargo/guide/dependencies.html" target="_blank" rel="noopener noreferrer">Dependencies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and <a href="https://doc.rust-lang.org/nightly/cargo/guide/project-layout.html" target="_blank" rel="noopener noreferrer">Package Layout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> sections are particularly relevant for this tutorial.</p> <h2 id="setting-up-dependencies"><a href="#setting-up-dependencies" aria-hidden="true" class="header-anchor">#</a> Setting up dependencies</h2> <p>Dependencies are specified in the <em>package manifest</em>: <code>Cargo.toml</code>.
If you open <code>Cargo.toml</code>, you'll see a line at the bottom of the file that says <code>[dependencies]</code>, which is the syntax for a TOML table called <code>dependencies</code>.
At this point you're probably thinking that this is where you'd add the necessary library dependencies.</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">map_vec</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>
<span class="token key property">oasis-std</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>
<span class="token key property">serde</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;derive&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></div><p><a href="https://docs.rs/oasis-std" target="_blank" rel="noopener noreferrer"><code>oasis-std</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains a collection of types and utilities that make writing blockchain services more pleasant.
<a href="https://serde.rs" target="_blank" rel="noopener noreferrer"><code>serde</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a SERialization/DEserialization library that's used quite ubiquitously throughout the service and client.
<a href="https://docs.rs/map_vec" target="_blank" rel="noopener noreferrer"><code>map_vec</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains <code>Map</code> and <code>Set</code> data structures that trade asymptopic complexity for low constant factors; this tends to be more efficient when writing simple services.</p> <p>Those are the only two runtime dependencies that you need to specify.
You'll also want to add build and dev (test) dependencies:</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dev-dependencies</span><span class="token punctuation">]</span>
<span class="token key property">oasis-test</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>
</code></pre></div><p><a href="https://docs.rs/oasis-test" target="_blank" rel="noopener noreferrer"><code>oasis-test</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an in-memory blockchain simulator that you can use to semi-integration test your services.</p> <h2 id="defining-the-ballot-service"><a href="#defining-the-ballot-service" aria-hidden="true" class="header-anchor">#</a> Defining the Ballot Service</h2> <h3 id="from-cargo-to-cargo-cult"><a href="#from-cargo-to-cargo-cult" aria-hidden="true" class="header-anchor">#</a> From Cargo to Cargo Cult</h3> <p>Let's start with some scaffolding.
Pop open <code>main.rs</code> and add some lines:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> oasis_std<span class="token punctuation">::</span><span class="token punctuation">{</span>Address<span class="token punctuation">,</span> Context<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(oasis_std::Service)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Ballot <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oasis_std<span class="token punctuation">::</span><span class="token function">service!</span><span class="token punctuation">(</span>Ballot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are three things going on here, but none of them are particularly eventful.</p> <p>The first line has a <a href="https://doc.rust-lang.org/reference/items/use-declarations.html" target="_blank" rel="noopener noreferrer">use<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (import) statement that tells the Rust compiler where to look for the <code>Address</code> and <code>Context</code> types that we'll use later.</p> <p>The next group defines an empty struct (think object) that <em>derives</em> (automatically implements) the <code>Service</code> <a href="https://doc.rust-lang.org/rust-by-example/trait.html" target="_blank" rel="noopener noreferrer">trait<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which allows it to be stored on the blockchain.</p> <p>Finally, there's a main function that has the <code>oasis_std::service!</code> macro with the name of your service as an argument.
The macro generates a dispatcher that processes an incoming request–-it's just like a webserver listener.
You can include code before and after the macro invocation, if you so desire.</p> <p>Okay, enough boilerplate.
Now for the actual content!</p> <h3 id="defining-service-state"><a href="#defining-service-state" aria-hidden="true" class="header-anchor">#</a> Defining service state</h3> <p>The remaining steps to defining a service are 1) deciding what is contained in the state and 2) implementing the RPCs that manipulate the state.</p> <p>The fields of service state are defined in the struct annotated with <code>#[derive(Service)]</code>.
In our case, it's <code>Ballot</code> and it should end up looking like this:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Service)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Ballot <span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    tally<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    accepting_votes<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    admin<span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
    voters<span class="token punctuation">:</span> map_vec<span class="token punctuation">::</span>Map<span class="token operator">&lt;</span>Address<span class="token punctuation">,</span> u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Cool, it looks like a regular ol' struct.
The only thing to keep in mind is that the types must be serializable so that their data can be persisted to storage, but it's okay because <a href="https://serde.rs/data-model.html#types" target="_blank" rel="noopener noreferrer">most of the useful ones are<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
<code>*Map</code> and <code>*Set</code>? Most certainly.
<code>Vec</code>? Verily!
Simple <code>enum</code>s? Surely!
But references? Risky.
<code>Rc&lt;RefCell&lt;Pin&lt;Box&lt;T&gt;&gt;&gt;&gt;</code>? Not so much.
And of course, pointers: please don't.
Don't worry about remembering these, though.
The compiler will let you know if something won't fly.</p> <p>Great, so that's all there really is to defining service state.</p> <h3 id="defining-service-methods-rpcs"><a href="#defining-service-methods-rpcs" aria-hidden="true" class="header-anchor">#</a> Defining service methods (RPCs)</h3> <p>Like any Rust struct, a service state object can have methods attached using an <a href="https://doc.rust-lang.org/std/keyword.impl.html" target="_blank" rel="noopener noreferrer"><code>impl</code> item<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
In our case, all of the RPCs will be public functions inside of an <code>impl Ballot { ... }</code>.</p> <h4 id="the-constructor"><a href="#the-constructor" aria-hidden="true" class="header-anchor">#</a> The constructor</h4> <p>All services must have a constructor that returns an instance of the state.
The constructor is called before a service is deployed and initializes the state object.
As in normal Rust parlance, the constructor is <code>new</code>.</p> <p>Here's the constructor for a <code>Ballot</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> description<span class="token punctuation">:</span> String<span class="token punctuation">,</span> candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        description<span class="token punctuation">,</span>
        tally<span class="token punctuation">:</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> candidates<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        candidates<span class="token punctuation">,</span>
        accepting_votes<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        admin<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        voters<span class="token punctuation">:</span> map_vec<span class="token punctuation">::</span>Map<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's break that down a bit.
First the function signature.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> description<span class="token punctuation">:</span> String<span class="token punctuation">,</span> candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span>
</code></pre></div><p>The <code>pub</code> is the visibility modifier and denotes that the function is an RPC method.
<code>ctx: &amp;Context</code> is a reference to a <a href="https://docs.rs/oasis-std/0.1.0/oasis-std/exe/struct.Context.html" target="_blank" rel="noopener noreferrer"><code>Context</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> object that contains the---you guessed it---context of the invoked method.
<code>description</code> and <code>candidates</code> are <code>String</code> arguments that are passed in by the client.
<code>-&gt; Self</code> denotes that the function returns a <code>Self</code>, which is just an alias to the <code>&lt;Thing&gt;</code> in <code>impl &lt;Thing&gt;</code>.
The constructor must return either <code>Self</code> or <code>&lt;Thing&gt;</code>.</p> <h3 id="some-simple-getters"><a href="#some-simple-getters" aria-hidden="true" class="header-anchor">#</a> Some simple getters</h3> <p>It'd probably be helpful if clients could retrieve the description of the ballot and the names of the candidates, right?
One could even imagine a web app that finds public polls and shows them in a spiffy UI.</p> <p>With this use case in mind, let's add some methods that return the desired data.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Returns the description of this ballot.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>description
<span class="token punctuation">}</span>

<span class="token comment">/// Returns the candidates being voted upon.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">candidates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span>str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>candidates<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>String<span class="token punctuation">::</span>as_ref<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>These are similar to the constructor but a bit different.
In non-constructor RPC methods, we have access to the state of the service, as provided by a reference to <code>self</code>.
We can pick the items out of <code>self</code> that we want and return them to the user.
Note that <em>all</em> RPC methods---even those that do not use <code>self</code> and <code>Context</code>---receive these two arguments, but you are free to ignore them.</p> <h3 id="mutating-state"><a href="#mutating-state" aria-hidden="true" class="header-anchor">#</a> Mutating state</h3> <p>Now to implement the core of the ballot service.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Cast a vote for a candidate.</span>
<span class="token comment">/// `candidate_num` is the index of the chosen candidate in `Ballot::candidates`.</span>
<span class="token comment">/// If you have already voted, this will change your vote to the new candidate.</span>
<span class="token comment">/// Voting for an invalid candidate or after the ballot has closed will return an `Err`.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> candidate_num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;Voting is closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> candidate_num <span class="token keyword">as</span> usize <span class="token operator">&gt;=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>candidates<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid candidate `{}`.&quot;</span><span class="token punctuation">,</span> candidate_num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>prev_vote<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>voters<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate_num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tally<span class="token punctuation">[</span>prev_vote <span class="token keyword">as</span> usize<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>tally<span class="token punctuation">[</span>candidate_num <span class="token keyword">as</span> usize<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Closes this ballot so that it no longer collects votes.</span>
<span class="token comment">/// Only the ballot creator can close voting.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>admin <span class="token operator">!=</span> ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;You cannot close the ballot.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Again, pretty close to what we've already seen.
<code>pub fn</code>s, <code>Context</code>s, and all that.
If you look closely, though, you'll see that <code>&amp;self</code> has changed to <code>&amp;mut self</code>, but this is just Rust's way to know that you want a mutable reference to <code>self</code>; it just <em>happens</em> to be the case that modifying <code>self</code> will be persisted to storage.</p> <p>The other new thing here is error handling.
In Rust, this is done by returning a <a href="https://doc.rust-lang.org/std/result/index.html" target="_blank" rel="noopener noreferrer"><code>Result&lt;T, E&gt;</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
The <code>T</code> type in both <code>Result</code>-returning functions is nothing: <code>()</code>, but we return string slices as errors to let the caller know what went wrong.
Returning errors will <em>not</em> revert the transaction, but panicking will.
You can trigger a panic using the <code>panic!</code> macro (or, if you look closely, the overflowing arithmetic in <code>vote</code>).</p> <p>A-okay, this is starting to look like a ballot service to me!</p> <h3 id="winner-winner"><a href="#winner-winner" aria-hidden="true" class="header-anchor">#</a> Winner, winner!</h3> <p>And what ballot would be complete without a way to tell who got the most votes?
(Other than a rigged ballot, perhaps, but that's why you're using blockchain!)
Let's add one more getter:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Returns the index of the candidate with the most votes.</span>
<span class="token comment">/// This method can only be called after voting has closed.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>u32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;Voting is not closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span>
        <span class="token punctuation">.</span>tally
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">max_by_key</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token punctuation">(</span>_i<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> u32<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="testing"><a href="#testing" aria-hidden="true" class="header-anchor">#</a> Testing</h2> <p>Although Rust might sometimes feel like &quot;if it compiles, it works,&quot; it's nice to be able to convince oneself of correctness through tests.
&quot;But I just copied the code you gave me?&quot; say you, the diligent reader.
What? You think tutorial code <em>just works</em>?
What kind of developer experience would that be!
You'd better believe that there's some subtle bug in here somewhere.</p> <p>At the beginning of the tutorial, Cargo generated a bit of test scaffolding at the bottom of your <code>lib.rs</code>.
It should look a like this:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">it_works</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <a href="https://doc.rust-lang.org/book/ch11-00-testing.html" target="_blank" rel="noopener noreferrer">Rust book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, as ever, will tell you all you need to know about <code>#[cfg(test)]</code>, <code>#[test]</code>, and the like.
For our purposes, we'll want to replace the generated code with the following chunk.
I promise that this isn't where the bug is.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token comment">/// Creates a new account and a `Context` with the new account as the sender.</span>
    <span class="token keyword">fn</span> <span class="token function">create_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span>Address<span class="token punctuation">,</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> addr <span class="token operator">=</span> oasis_test<span class="token punctuation">::</span><span class="token function">create_account</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token comment">/* initial balance */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ctx <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with_sender</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with_gas</span><span class="token punctuation">(</span><span class="token number">100_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>addr<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">functionality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>_admin<span class="token punctuation">,</span> admin_ctx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">create_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>_voter<span class="token punctuation">,</span> voter_ctx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">create_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> description <span class="token operator">=</span> <span class="token string">&quot;What's for dinner?&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> candidates <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">&quot;beef&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;yogurt&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> ballot <span class="token operator">=</span>
            Ballot<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> description<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidates<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">candidates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Can't get winner before voting has closed.</span>
        <span class="token function">assert!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Non-admin can't close ballot.</span>
        ballot<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Votes can't be cast after ballot has closed.</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are two things to note here.
The first is that, when external to the service (i.e. not in <code>mod service</code>), <code>Ballot</code> refers to the service client which can deploy and/or interact with a deployed service.
The other is that you can create your own <code>Context</code> to pass to the service RPCs.
When testing, you can explicitly set the <code>sender</code>, but this will be your account when deploying in production.
Testing accounts are created using <code>oasis_test::create_account</code>.</p> <p>You can now run the test using <code>oasis test</code>.
(protip: use <code>oasis test -- --nocapture</code> to pass through stdout and stderr).
This will run your tests using the blockchain simulator in <code>oasis-test</code>.
If all goes well, you should see your test pass.
Okay, so maybe there was no bug, but at least you now know how to test your service!</p> <h2 id="onward-to-messages-of-victory"><a href="#onward-to-messages-of-victory" aria-hidden="true" class="header-anchor">#</a> Onward to (messages of) victory!</h2> <p>Congratulations on completing the first tutorial!
You can now imagine that you could hold elections on dinner, your fantasy sportsball team, or the supreme ruler of your digital nation state (digital nation state not included).</p> <p>Up next is a confidential message board service that demonstrates more advanced concepts like events and custom types.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/oasislabs/docs/edit/master/tutorials/ballot.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/quickstart.html" class="prev">
          Quickstart
        </a></span> <span class="next"><a href="/tutorials/messaging.html">
          Intermediate: Private Chat
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0c452a0.js" defer></script><script src="/assets/js/2.8656bac5.js" defer></script><script src="/assets/js/8.8c045a5f.js" defer></script>
  </body>
</html>
